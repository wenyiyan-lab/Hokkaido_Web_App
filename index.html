<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> 
    <meta name="apple-mobile-web-app-title" content="2025北海道">
    <meta name="theme-color" content="#F2F0E9">

    <!-- APP ICON (New Design) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzFBMUExQSIvPgogIDxwYXRoIGQ9Ik0yNTYgMTIwIEw0MzAgNDAwIEg4MiBaIiBmaWxsPSJub25lIiBzdHJva2U9IiNGMkYwRTkiIHN0cm9rZS13aWR0aD0iMTIiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KICA8cGF0aCBkPSJNMjU2IDE0MCBMMzUwIDQwMCBNMTYyIDQwMCBMMjU2IDE0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRjJGMEU5IiBzdHJva2Utd2lkdGg9IjQiIG9wYWNpdHk9IjAuMiIvPgogIDxjaXJjbGUgY3g9IjI1NiIgY3k9IjIzMCIgcj0iMzUiIGZpbGw9IiM4QzcwNTEiLz4KICA8dGV4dCB4PSIyNTYiIHk9IjQ2MCIgZm9udC1mYW1pbHk9IidDb3Jtb3JhbnQgR2FyYW1vbmQnLCBzZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZvbnQtc2l6ZT0iNDIiIGZpbGw9IiM4QzcwNTEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGxldHRlci1zcGFjaW5nPSI4Ij5IT0tLQUlETzwvdGV4dD4KPC9zdmc+">
    
    <title>2025北海道</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">

    <!-- Config & Custom Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paper': '#F2F0E9', // 更溫暖的舊紙色
                        'ink': '#1A1A1A',   // 深邃黑
                        'bronze': '#8C7051', // 沈穩的古銅
                        'accent': '#C25E00', // 愛馬仕橘 (點綴用)
                        'subtle': '#8C8C8C', 
                        'line': '#E5E2D9',  // 分隔線顏色
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', '"Cormorant Garamond"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        display: ['"Cormorant Garamond"', 'serif'], // 用於大標題的英文
                    },
                    boxShadow: {
                        'gallery': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                        'float': '0 20px 40px -5px rgba(0, 0, 0, 0.15)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                    },
                    backgroundImage: {
                        'noise': "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRjJGMEU5Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMDMiLz4KPC9zdmc+')",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F2F0E9;
            color: #1A1A1A;
            -webkit-font-smoothing: antialiased;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRjJGMEU5Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiIG9wYWNpdHk9IjAuMDMiLz4KPC9zdmc+');
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input, textarea, select {
            background: transparent;
            border-bottom: 1px solid #D1CDC4;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: 'Noto Serif TC', serif;
            border-radius: 0; 
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-bottom: 1px solid #1A1A1A;
        }

        /* Special input styling for Wallet Input */
        .wallet-input {
            border-bottom: 1px solid #E5E2D9;
            padding: 8px 0;
            font-size: 1.1rem;
        }
        .wallet-input::placeholder {
            color: #D1CDC4;
            font-family: 'Noto Serif TC', serif;
        }
        .wallet-input:focus {
            border-bottom: 1px solid #8C7051;
        }

        .fade-in { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); filter: blur(5px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        .glass-nav {
            background: rgba(242, 240, 233, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .stamp-reserved {
            border: 1px solid #8C7051;
            color: #8C7051;
            padding: 2px 6px;
            font-size: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-radius: 2px;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
        }

        /* Reserved Event Styling */
        .event-reserved {
            background: rgba(140, 112, 81, 0.05); /* Bronze tint */
            border-left: 4px solid #8C7051;
            padding-left: 12px;
            padding-right: 12px;
            padding-top: 8px;
            padding-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Modal Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes popOut {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.95); }
        }
        
        .animate-pop-in { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop-out { animation: popOut 0.2s ease-in forwards; }

        #modal.hidden { display: none; }
        #modal:not(.hidden) { display: flex; }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep {
            0%    {opacity: 0; transform: translateY(-10px)}
            100%  {opacity: 1; transform: translateY(0)}
        }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden selection:bg-bronze selection:text-white">

    <!-- Header -->
    <header class="flex-none px-6 pt-8 pb-4 z-20 flex justify-between items-end relative">
        <div class="absolute bottom-0 left-6 right-6 h-px bg-gradient-to-r from-transparent via-ink/20 to-transparent"></div>
        
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 bg-accent rounded-full"></span>
                <h2 class="text-[10px] tracking-[0.3em] text-bronze uppercase font-bold font-sans">Winter Journey</h2>
            </div>
            <h1 class="text-4xl font-display italic text-ink leading-none">2025</h1>
            <h1 class="text-xl font-serif font-light text-ink/80 tracking-widest mt-1">北海道</h1>
        </div>
        <div class="text-right pb-1">
            <div class="text-4xl font-display text-ink/10 absolute top-4 right-4 -z-10 select-none">2025</div>
            <span id="weather-icon" class="text-xl text-ink block mb-1 opacity-60"><i class="fa-solid fa-snowflake"></i></span>
            <span class="text-[10px] font-mono text-subtle block tracking-wider">DEC 24-29</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-1 overflow-y-auto hide-scrollbar p-6 pb-32 relative scroll-smooth">
        <!-- Dynamic Content Injected Here -->
    </main>

    <!-- Bottom Navigation -->
    <nav class="absolute bottom-0 left-0 right-0 z-30">
        <div class="glass-nav px-6 py-4 flex justify-between items-center max-w-md mx-auto">
            <button onclick="renderPlan()" class="nav-btn group relative w-12 h-12 flex items-center justify-center rounded-full hover:bg-ink/5 transition-all" data-tab="plan">
                <i class="fa-solid fa-calendar-days text-lg text-subtle group-[.active]:text-ink transition-colors"></i>
                <span class="absolute -bottom-2 text-[9px] font-bold uppercase tracking-widest text-ink opacity-0 group-[.active]:opacity-100 transition-all transform group-[.active]:translate-y-0 translate-y-1">Plan</span>
            </button>
            
            <button onclick="renderWeather()" class="nav-btn group relative w-12 h-12 flex items-center justify-center rounded-full hover:bg-ink/5 transition-all" data-tab="weather">
                <i class="fa-solid fa-cloud-sun text-lg text-subtle group-[.active]:text-ink transition-colors"></i>
                <span class="absolute -bottom-2 text-[9px] font-bold uppercase tracking-widest text-ink opacity-0 group-[.active]:opacity-100 transition-all transform group-[.active]:translate-y-0 translate-y-1">Weather</span>
            </button>
            
            <button onclick="renderWallet()" class="nav-btn group relative -mt-6 w-14 h-14 bg-ink text-paper rounded-full shadow-float flex items-center justify-center hover:scale-105 active:scale-95 transition-all" data-tab="wallet">
                <i class="fa-solid fa-wallet text-xl"></i>
            </button>

            <button onclick="renderLists()" class="nav-btn group relative w-12 h-12 flex items-center justify-center rounded-full hover:bg-ink/5 transition-all" data-tab="lists">
                <i class="fa-solid fa-list-check text-lg text-subtle group-[.active]:text-ink transition-colors"></i>
                <span class="absolute -bottom-2 text-[9px] font-bold uppercase tracking-widest text-ink opacity-0 group-[.active]:opacity-100 transition-all transform group-[.active]:translate-y-0 translate-y-1">Lists</span>
            </button>
            
            <button onclick="renderDocs()" class="nav-btn group relative w-12 h-12 flex items-center justify-center rounded-full hover:bg-ink/5 transition-all" data-tab="docs">
                <i class="fa-solid fa-folder-open text-lg text-subtle group-[.active]:text-ink transition-colors"></i>
                <span class="absolute -bottom-2 text-[9px] font-bold uppercase tracking-widest text-ink opacity-0 group-[.active]:opacity-100 transition-all transform group-[.active]:translate-y-0 translate-y-1">Docs</span>
            </button>
        </div>
    </nav>

    <!-- Modal Structure (Fixed) -->
    <div id="modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm cursor-pointer" onclick="closeModal()"></div>
        
        <!-- Modal Container -->
        <div id="modal-container" class="bg-[#F9F8F6] w-11/12 max-w-sm rounded-2xl shadow-2xl p-6 relative pointer-events-auto max-h-[90vh] overflow-y-auto z-10 opacity-0 transform scale-95">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- DATA ---
        const FLIGHT_DATA = [
            { type: 'Departure', code: 'CI130', date: '12/24', fromCode: 'TPE', fromCity: 'Taipei', timeDep: '08:35', toCode: 'CTS', toCity: 'Sapporo', timeArr: '13:10', duration: '3h 35m' },
            { type: 'Return', code: 'CI131', date: '12/29', fromCode: 'CTS', fromCity: 'Sapporo', timeDep: '15:00', toCode: 'TPE', toCity: 'Taipei', timeArr: '18:XX', duration: '4h 10m' }
        ];

        const DEFAULT_ITINERARY = [
            { day: 1, date: "12/24", title: "洞爺湖", subtitle: "Lake Toya", location: "TPE -> CTS", events: [ { id: 1, time: "05:00", title: "家中集合", desc: "接駁車出發", type: "transport", transportType: 'charter', transportRoute: "家裡 -> 桃園機場", important: true, bookingStatus: 'fixed', showMap: false }, { id: 2, time: "05:35", title: "抵達桃園機場", desc: "T1 / 辦理登機", type: "transport", transportType: 'walk', bookingStatus: 'fixed', showMap: true }, { id: 3, time: "08:35", title: "起飛 CI130", desc: "Flight: 3h 35m", type: "flight", bookingStatus: 'fixed', showMap: false }, { id: 4, time: "13:10", title: "抵達新千歲", desc: "入境、領行李", type: "flight", bookingStatus: 'fixed', showMap: true }, { id: 5, time: "14:30", title: "包車前往洞爺", desc: "車程約 2 小時", type: "transport", transportType: 'charter', transportRoute: "新千歲機場 -> 洞爺乃之風", important: true, bookingStatus: 'fixed', showMap: false }, { id: 6, time: "17:00", title: "洞爺乃之風", desc: "Check-in / 湖景", type: "hotel", bookingStatus: 'fixed', showMap: true }, { id: 7, time: "18:30", title: "自助晚餐", desc: "飯店餐廳", type: "food", bookingStatus: 'flexible', openingHours: "17:30 - 21:00", showMap: false } ] },
            { day: 2, date: "12/25", title: "札幌、狸小路", subtitle: "Sapporo City", location: "Toya -> Sapporo", events: [ { id: 10, time: "10:00", title: "飯店接駁車", desc: "往札幌北口 (重要)", type: "transport", transportType: 'public', transportRoute: "洞爺乃之風 -> 札幌北口", important: true, bookingStatus: 'fixed', showMap: false }, { id: 11, time: "12:30", title: "Vessel Hotel", desc: "寄放行李 / Check-in", type: "hotel", bookingStatus: 'fixed', showMap: true }, { id: 12, time: "13:30", title: "湯咖哩", desc: "Suage+ 或 Garage", type: "food", bookingStatus: 'flexible', openingHours: "11:30 - 21:30", showMap: true }, { id: 13, time: "15:00", title: "狸小路", desc: "散策 / 藥妝採買", type: "sight", bookingStatus: 'flexible', openingHours: "10:00 - 22:00", showMap: true }, { id: 14, time: "18:00", title: "炭火兜 羊肉", desc: "成吉思汗烤肉 (已預約)", type: "food", important: true, bookingStatus: 'fixed', openingHours: "17:00 - 23:00", showMap: true } ] },
            { day: 3, date: "12/26", title: "旭川、四季彩之丘、精靈露臺", subtitle: "Asahikawa & Furano", location: "Asahikawa / Biei", events: [ { id: 20, time: "08:00", title: "包車出發", desc: "飯店門口", type: "transport", transportType: 'charter', transportRoute: "札幌飯店 -> 旭山動物園", important: true, bookingStatus: 'fixed', showMap: false }, { id: 21, time: "10:30", title: "旭山動物園", desc: "企鵝散步 (11:00)", type: "sight", bookingStatus: 'flexible', openingHours: "10:30 - 15:30", showMap: true }, { id: 22, time: "13:15", title: "四季彩之丘", desc: "雪上活動", type: "sight", bookingStatus: 'flexible', openingHours: "09:00 - 16:30", showMap: true }, { id: 23, time: "15:00", title: "森林精靈露臺", desc: "富良野", type: "sight", bookingStatus: 'flexible', openingHours: "12:00 - 20:45", showMap: true }, { id: 24, time: "19:00", title: "返回札幌", desc: "市區晚餐", type: "transport", transportType: 'charter', transportRoute: "富良野 -> 札幌市區", bookingStatus: 'fixed', showMap: false } ] },
            { day: 4, date: "12/27", title: "小樽", subtitle: "Otaru Canal", location: "Sapporo -> Otaru", events: [ { id: 30, time: "09:30", title: "JR 札幌站", desc: "快速 Airport", type: "transport", transportType: 'public', transportRoute: "札幌站 -> 小樽站", bookingStatus: 'flexible', showMap: false }, { id: 31, time: "10:30", title: "三角市場", desc: "海鮮丼早午餐", type: "food", bookingStatus: 'flexible', openingHours: "07:00 - 16:00", showMap: true }, { id: 32, time: "12:00", title: "小樽運河", desc: "散步、拍照", type: "sight", bookingStatus: 'flexible', showMap: true }, { id: 33, time: "13:30", title: "堺町通", desc: "甜點巡禮", type: "sight", bookingStatus: 'flexible', openingHours: "09:00 - 18:00", showMap: true }, { id: 34, time: "16:30", title: "運河點燈", desc: "藍色時刻", type: "sight", bookingStatus: 'flexible', showMap: true }, { id: 35, time: "18:00", title: "晚餐", desc: "壽司通 / 炸雞", type: "food", bookingStatus: 'flexible', showMap: true } ] },
            { day: 5, date: "12/28", title: "札幌", subtitle: "Sapporo Free Day", location: "Sapporo", events: [ { id: 40, time: "10:00", title: "二條市場", desc: "海鮮", type: "food", bookingStatus: 'flexible', openingHours: "07:00 - 17:00", showMap: true }, { id: 41, time: "13:00", title: "北海道神宮", desc: "參拜", type: "sight", bookingStatus: 'flexible', openingHours: "07:00 - 16:00", showMap: true }, { id: 42, time: "15:00", title: "大通公園", desc: "市集 / 電視塔", type: "sight", bookingStatus: 'flexible', showMap: true }, { id: 43, time: "19:00", title: "居酒屋", desc: "最後晚餐", type: "food", bookingStatus: 'flexible', showMap: true } ] },
            { day: 6, date: "12/29", title: "新千歲機場", subtitle: "New Chitose Airport", location: "Sapporo -> TPE", events: [ { id: 50, time: "09:00", title: "Check-out", desc: "前往機場", type: "hotel", bookingStatus: 'fixed', showMap: false }, { id: 51, time: "11:00", title: "新千歲機場", desc: "國內線伴手禮", type: "sight", bookingStatus: 'flexible', showMap: true }, { id: 52, time: "13:30", title: "報到", desc: "CI131", type: "flight", bookingStatus: 'fixed', showMap: false }, { id: 53, time: "15:00", title: "起飛", desc: "再見北海道", type: "flight", bookingStatus: 'fixed', showMap: false } ] }
        ];

        const DEFAULT_CHECKLIST = [
            { text: "護照（有效期限6個月以上）", done: false }, { text: "身分證影本", done: false }, { text: "機票／電子登機證", done: false }, { text: "飯店預約資訊", done: false }, { text: "旅責險／旅平險保單", done: false }, { text: "日幣現金", done: false }, { text: "信用卡（Visa / JCB）", done: false }, { text: "西瓜卡 Suica / Kitaca", done: false }, { text: "行動電源", done: false }, { text: "充電線", done: false }, { text: "iPhone / Apple Watch 充電器", done: false }, { text: "相機 / 記憶卡", done: false }, { text: "耳機", done: false }, { text: "口罩", done: false }, { text: "濕紙巾／酒精", done: false }, { text: "小藥包", done: false }, 
            { text: "墨鏡", done: false }, { text: "汙衣袋", done: false }, { text: "洗碗精", done: false }, { text: "眼鏡", done: false }, { text: "隱形眼鏡", done: false },
            { text: "發熱衣 2–3件", done: false }, { text: "羊毛針織或保暖中層", done: false }, { text: "羽絨外套", done: false }, { text: "保暖褲／刷毛褲", done: false }, { text: "厚襪／羊毛襪 3–5雙", done: false }, { text: "帽子", done: false }, { text: "圍巾", done: false }, { text: "手套", done: false }, { text: "防滑雪靴", done: false }, { text: "洗面乳", done: false }, { text: "乳液（極潤）", done: false }, { text: "護唇膏", done: false }, { text: "防曬乳", done: false }, { text: "卸妝用品", done: false }, { text: "牙膏牙刷", done: false }, { text: "髮油或整髮用品", done: false }, { text: "保養品", done: false }, { text: "折疊雨傘", done: false }, { text: "小玩具", done: false }, { text: "折凳", done: false }, { text: "夾鏈袋", done: false }
        ];

        // State
        let itinerary = JSON.parse(localStorage.getItem('itinerary_v4')) || DEFAULT_ITINERARY;
        itinerary.forEach(day => {
            day.events.forEach(event => {
                if(event.showMap === undefined) event.showMap = false;
            });
        });

        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        if (expenses.length > 0 && !expenses[0].id) {
            expenses = expenses.map((e, i) => ({ ...e, id: Date.now() + i }));
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        let checklist = [];
        try {
            const savedChecklist = JSON.parse(localStorage.getItem('checklist_v6'));
            checklist = Array.isArray(savedChecklist) ? savedChecklist : DEFAULT_CHECKLIST;
        } catch (e) { checklist = DEFAULT_CHECKLIST; }
        
        let shoppingList = [];
        try {
            const savedShoppingList = JSON.parse(localStorage.getItem('shoppingList'));
            if (Array.isArray(savedShoppingList)) {
                shoppingList = savedShoppingList;
            }
        } catch (e) { shoppingList = []; }

        let memos = localStorage.getItem('memos') || "";
        let exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 0.215;
        // Update documents_v3 to include new record
        let documents = JSON.parse(localStorage.getItem('documents_v3')) || [
            {id: 1, title: '機票訂位(燦星)', type: 'flight', bookingId: '00146092', link: 'https://drive.google.com/file/d/1JsNjzrh-3QQL8e-hihzgXAWqvbNAI1TR/view?usp=drive_link'},
            {id: 2, title: '電子機票(廖浚錴)', type: 'flight', bookingId: '6MP7BS', link: 'https://drive.google.com/file/d/1mqhIXUaqgzG2-2lKRkdP_2LDG5wDWzI6/view?usp=drive_link'},
            {id: 3, title: '電子機票(廖尉翔)', type: 'flight', bookingId: '6MP7BS', link: 'https://drive.google.com/file/d/1cogmQC93_hViNbxSH6OntxI7T3Nc6554/view?usp=drive_link'},
            {id: 4, title: '電子機票(顏雯憶)', type: 'flight', bookingId: '6MP7BS', link: 'https://drive.google.com/file/d/1bdCPJ5YS0hQPiXROaVWrCVn5JNbxMoJ1/view?usp=drive_link'},
            {id: 5, title: '機場到洞爺湖接駁車訂購紀錄', type: 'file', bookingId: '', link: 'https://drive.google.com/file/d/1JMqOjuINijSzLkXsyg1pFXdN_FErjkpz/view?usp=drive_link'},
            {id: 6, title: '洞爺乃之風訂購紀錄', type: 'hotel', bookingId: '6123851357', link: 'https://drive.google.com/file/d/1UKPpIQwH-U1EUSwgXiy4gYSNvDOKdK8K/view?usp=drive_link'},
            {id: 7, title: '洞爺湖湯屋預約紀錄', type: 'hotel', bookingId: '', link: 'https://drive.google.com/file/d/1dWU_FbmHBEgW1xbse5Ah6Mc5jhCCclNW/view?usp=drive_link'},
            {id: 8, title: '乃之風到札幌接駁預約紀錄', type: 'file', bookingId: '', link: 'https://drive.google.com/file/d/1HEXWN2-l05RighTOIViwmgAPEAfq7JmW/view?usp=drive_link'},
            {id: 9, title: 'VESSEL1225至1228廖訂房紀錄', type: 'hotel', bookingId: '2438-7225-9949', link: 'https://drive.google.com/file/d/1VAgAtjc0BOlCI6iEoj1rCAse0tP2bEsf/view?usp=drive_link'},
            {id: 17, title: 'VESSEL1225至1228張訂房紀錄', type: 'hotel', bookingId: '2438-7332-9820', link: 'https://drive.google.com/file/d/177-qghodjcjVDKe9kcJWk2xaKRjNmJ3l/view?usp=drive_link'},
            {id: 10, title: 'VESSEL1228至1229張訂房紀錄', type: 'hotel', bookingId: '2441-3249-1571', link: 'https://drive.google.com/file/d/1b6k_yf6I-BRjoXYG-0qFbm-q6Jn69NRj/view?usp=drive_link'},
            {id: 11, title: 'VESSEL1228至1229廖訂房紀錄', type: 'hotel', bookingId: '2441-3248-7585', link: 'https://drive.google.com/file/d/1EwwjAn_FBCKu3J8BYAnPrXpcE7pXbaVq/view?usp=drive_link'},
            {id: 12, title: '四季彩之秋預約紀錄', type: 'file', bookingId: '', link: 'https://drive.google.com/file/d/1VVvtUy7Ruxu43YvRXXTi9heut_0NeDXF/view?usp=drive_link'},
            {id: 13, title: '1225日炭火兜18點預約紀錄', type: 'food', bookingId: 'VZ639M5HNG', link: 'https://drive.google.com/file/d/1RJPleQ4zp7187xlCSuG_jsCazjdRULxk/view?usp=drive_link'},
            {id: 14, title: '1227難陀19點吃到飽預約紀錄', type: 'food', bookingId: '', link: 'https://drive.google.com/file/d/1Ou8jke7i8ew5ebxAYEpcZYPJ3IG4sBRq/view?usp=drive_link'},
            {id: 15, title: '廖浚錴旅平險1224~1230', type: 'file', bookingId: '', link: 'https://drive.google.com/file/d/1yD30_QqJ7s0FyM_qLB0dh5MsctzD7uL6/view?usp=drive_link'},
            {id: 16, title: '顏雯憶廖尉翔1224~1230', type: 'file', bookingId: '', link: 'https://drive.google.com/file/d/12scvumwAHbWxUpqdlTgH2HgD6eN1rKdy/view?usp=drive_link'},
        ];
        
        let initialBudget = parseFloat(localStorage.getItem('initialBudget')) || 100000;
        let currentWalletFilter = 'all'; 
        let currentPaymentMethod = 'cash'; 
        let currentDayIndex = 0;
        let pendingConfirmAction = null;
        let activeListTab = 'packing'; // 'packing' or 'shopping'

        function saveAll() {
            localStorage.setItem('itinerary_v4', JSON.stringify(itinerary)); 
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('checklist_v6', JSON.stringify(checklist));
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            localStorage.setItem('memos', memos);
            localStorage.setItem('exchangeRate', exchangeRate);
            localStorage.setItem('documents_v3', JSON.stringify(documents)); 
            localStorage.setItem('initialBudget', initialBudget);
        }

        const appContent = document.getElementById('app-content');
        
        // --- MODAL SYSTEM ---
        function showModal(contentHTML) {
            const modal = document.getElementById('modal');
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = contentHTML;
            modal.classList.remove('hidden');
            
            // Reset animation
            container.classList.remove('animate-pop-out');
            container.classList.add('animate-pop-in');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            const container = document.getElementById('modal-container');
            
            container.classList.remove('animate-pop-in');
            container.classList.add('animate-pop-out');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                pendingConfirmAction = null;
            }, 200);
        }

        function openConfirmModal(message, actionCallback) {
            pendingConfirmAction = actionCallback;
            showModal(`
                <div class="text-center py-6">
                    <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <h3 class="font-serif text-xl text-ink mb-2">Are you sure?</h3>
                    <p class="text-sm text-stone-500 mb-6 px-4 leading-relaxed">${message}</p>
                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 py-3 rounded-lg border border-stone-300 text-stone-500 font-bold text-xs uppercase tracking-widest hover:bg-stone-50 transition-colors">Cancel</button>
                        <button onclick="executeConfirmAction()" class="flex-1 py-3 rounded-lg bg-red-500 text-white font-bold text-xs uppercase tracking-widest hover:bg-red-600 shadow-lg shadow-red-200 transition-colors">Delete</button>
                    </div>
                </div>
            `);
        }

        function executeConfirmAction() {
            if (pendingConfirmAction) pendingConfirmAction();
            closeModal();
        }

        function setActiveTab(tabName) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.tab === tabName) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            window.scrollTo(0,0);
        }

        // --- HELPER FOR ROUTE MAP ---
        function openDayRouteMap(dayIndex) {
            const day = itinerary[dayIndex];
            const locations = day.events
                .filter(e => ['sight', 'food', 'hotel'].includes(e.type))
                .map(e => {
                     // Enhanced query string for better matching
                     let query = e.title;
                     if (e.subtitle) query += " " + e.subtitle;
                     query += " Hokkaido";
                     return encodeURIComponent(query);
                });
            
            if (locations.length < 2) {
                alert("Need at least 2 locations (Sight, Food, Hotel) to create a route.");
                return;
            }

            const origin = locations[0];
            const destination = locations[locations.length - 1];
            const waypoints = locations.slice(1, -1).join('|');
            
            // Force travelmode to driving for better chaining
            let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
            if (waypoints) url += `&waypoints=${waypoints}`;
            
            window.open(url, '_blank');
        }

        // --- RENDER FUNCTIONS ---

        function renderPlan() {
            setActiveTab('plan');
            const day = itinerary[currentDayIndex];
            
            let html = `<div class="fade-in pb-10 flex flex-col h-full">`;
            
            // Flights Details
            html += `
                <div class="mb-4">
                    <details class="group bg-white rounded-xl shadow-gallery overflow-hidden border border-stone-100">
                        <summary class="flex justify-between items-center p-4 cursor-pointer bg-paper hover:bg-stone-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-bronze/10 text-bronze flex items-center justify-center"><i class="fa-solid fa-plane"></i></div>
                                <div><h3 class="font-serif font-bold text-ink leading-none">Flight Info</h3><div class="text-[10px] text-subtle mt-1 uppercase tracking-widest">CI130 / CI131</div></div>
                            </div>
                            <span class="text-stone-400 group-open:rotate-180 transition-transform"><i class="fa-solid fa-chevron-down"></i></span>
                        </summary>
                        <div class="p-5 border-t border-stone-100 bg-white">
                            ${FLIGHT_DATA.map(f => `<div class="mb-6 last:mb-0 relative"><div class="flex justify-between items-end mb-2"><div class="text-xs font-bold text-bronze uppercase tracking-widest border border-bronze/30 px-2 py-0.5 rounded">${f.type}</div><div class="text-sm font-mono text-stone-400">${f.date}</div></div><div class="flex justify-between items-center font-serif text-ink mb-1"><div class="text-center"><div class="text-2xl font-bold leading-none">${f.fromCode}</div><div class="text-[10px] text-subtle mt-1">${f.timeDep}</div></div><div class="flex-1 px-4 text-center"><div class="border-t border-dashed border-stone-300 relative top-1.5"></div><i class="fa-solid fa-plane text-stone-300 text-xs relative bg-white px-1"></i><div class="text-[9px] text-stone-400 mt-1">${f.duration}</div></div><div class="text-center"><div class="text-2xl font-bold leading-none">${f.toCode}</div><div class="text-[10px] text-subtle mt-1">${f.timeArr}</div></div></div></div>`).join('<div class="h-px bg-stone-100 my-4 w-full"></div>')}
                            <div class="mt-4 pt-4 border-t border-stone-100 flex justify-center">
                                <a href="https://www.china-airlines.com/tw/zh/fly/flight-status/index" target="_blank" class="text-xs bg-[#8C7051] text-white px-4 py-2 rounded-full hover:bg-[#7a6145] transition-colors flex items-center gap-2">
                                    <i class="fa-solid fa-plane-circle-check"></i> 中華航空航班動態
                                </a>
                            </div>
                        </div>
                    </details>
                </div>
            `;

            // Day Selector
            html += `
                <div class="sticky top-0 z-20 bg-[#F2F0E9]/95 backdrop-blur-sm pt-2 pb-2 border-b border-stone-200/50 mb-4">
                    <div class="flex justify-between items-center px-4 mb-2">
                        <span class="text-[9px] uppercase tracking-[0.2em] text-bronze font-bold">Select Day</span>
                        <div class="flex gap-2">
                            <button onclick="switchDay(currentDayIndex - 1)" class="text-stone-400 hover:text-ink disabled:opacity-30" ${currentDayIndex === 0 ? 'disabled' : ''}><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="switchDay(currentDayIndex + 1)" class="text-stone-400 hover:text-ink disabled:opacity-30" ${currentDayIndex === itinerary.length - 1 ? 'disabled' : ''}><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto hide-scrollbar whitespace-nowrap px-2 pb-2">
                        <div class="flex gap-3 justify-between sm:justify-start">
                            ${itinerary.map((day, idx) => `<button onclick="switchDay(${idx})" class="transition-all duration-300 flex flex-col items-center min-w-[50px] p-2 rounded-lg ${idx === currentDayIndex ? 'bg-white shadow-sm scale-105 border border-stone-100' : 'opacity-60 scale-95 hover:bg-white/50'}"><span class="font-display text-2xl ${idx === currentDayIndex ? 'text-accent' : 'text-stone-400'} italic leading-none">0${day.day}</span><span class="text-[9px] font-bold uppercase tracking-widest ${idx === currentDayIndex ? 'text-ink' : 'text-stone-400'} mt-1">${day.date}</span></button>`).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Day Content (Title + Route Map Button)
            html += `
                <div class="flex-1 px-1 animate-[fadeIn_0.4s_ease-out]">
                    <div class="mb-6 flex justify-between items-end group/header cursor-pointer">
                        <div onclick="editDayTitle(${currentDayIndex})">
                            <h2 class="font-serif text-3xl font-bold text-ink leading-none mb-1">${day.title}</h2>
                            <div class="text-xs tracking-[0.2em] uppercase text-bronze font-bold">${day.subtitle || 'Journey'}</div>
                        </div>
                        <button onclick="openDayRouteMap(${currentDayIndex})" class="text-[10px] border border-stone-300 px-3 py-1.5 rounded-full text-stone-500 hover:bg-bronze hover:text-white hover:border-bronze transition-all flex items-center gap-1">
                            <i class="fa-solid fa-map-location-dot"></i> Route Map
                        </button>
                    </div>
                    
                    <div class="space-y-6 relative ml-2">
                        <div class="absolute left-[7px] top-2 bottom-2 w-px bg-stone-300"></div>

                        ${day.events.map((event, eventIndex) => `
                            <div class="relative pl-8 group cursor-pointer" onclick="openEditEventModal(${currentDayIndex}, ${eventIndex})">
                                <div class="absolute left-0 top-1.5 w-[15px] h-[15px] bg-[#F2F0E9] border ${event.bookingStatus === 'fixed' ? 'border-ink bg-ink' : 'border-stone-400'} rounded-full z-10 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full ${event.important ? 'bg-accent' : (event.bookingStatus === 'fixed' ? 'bg-paper' : 'bg-stone-300')}"></div>
                                </div>
                                <div class="transition-all duration-300 hover:translate-x-1 ${event.bookingStatus === 'fixed' ? 'event-reserved' : 'relative'}">
                                    <div class="flex items-center gap-3 mb-1">
                                        <span class="font-display text-xl ${event.important ? 'text-accent' : 'text-ink'} w-14 leading-none">${event.time}</span>
                                        <div class="flex gap-2">
                                            <span class="text-[10px] font-bold uppercase tracking-wider text-subtle border border-stone-200 px-1.5 py-0.5 rounded">${event.type}</span>
                                            ${event.bookingStatus === 'fixed' ? '<span class="stamp-reserved bg-paper">RESERVED</span>' : ''}
                                        </div>
                                    </div>
                                    <h3 class="font-serif text-lg font-bold text-ink mb-1 group-active:text-bronze transition-colors flex items-center gap-2">
                                        ${event.title} ${getTransportIcon(event)}
                                    </h3>
                                    ${event.openingHours ? `<div class="text-[10px] text-subtle mb-2 font-mono flex items-center gap-1.5"><i class="fa-regular fa-clock text-stone-400"></i> ${event.openingHours}</div>` : ''}
                                    <div class="text-sm text-stone-500 font-light leading-relaxed border-l-2 ${event.important && event.bookingStatus !== 'fixed' ? 'border-accent/30' : 'border-transparent'} pl-2 -ml-2">
                                        <div class="mb-1">${event.desc}</div>
                                        ${event.transportRoute ? `<div class="text-xs font-mono text-bronze bg-bronze/5 px-2 py-1 inline-block rounded mt-1"><i class="fa-solid fa-route mr-1"></i>${event.transportRoute}</div>` : ''}
                                    </div>
                                    <div class="absolute right-0 top-1 text-stone-300 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen"></i></div>
                                    
                                    ${event.showMap ? `
                                    <div class="mt-3 flex items-center justify-between">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title + ' Hokkaido')}" 
                                           target="_blank" 
                                           onclick="event.stopPropagation()"
                                           class="group/map flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-widest text-stone-400 hover:text-white hover:bg-bronze border border-stone-200 hover:border-bronze rounded-full px-3 py-1.5 transition-all">
                                           <i class="fa-solid fa-location-dot group-hover/map:text-white transition-colors"></i> 
                                           <span>Google Map</span>
                                        </a>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="openAddEventModal(${currentDayIndex})" class="mt-8 w-full py-3 border border-dashed border-stone-300 rounded-xl text-stone-400 text-xs hover:text-bronze hover:border-bronze transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Add Event to ${day.date}
                    </button>
                    ${currentDayIndex < itinerary.length - 1 ? `<div class="mt-8 pt-6 border-t border-stone-200"><button onclick="switchDay(${currentDayIndex + 1})" class="w-full bg-white border border-stone-200 shadow-sm p-4 rounded-xl flex justify-between items-center group hover:bg-stone-50 transition-colors"><div class="text-left"><div class="text-xs text-stone-400">Next Day</div><div class="font-serif font-bold text-ink">${itinerary[currentDayIndex + 1].title}</div></div><i class="fa-solid fa-arrow-right text-stone-300 group-hover:text-ink transition-colors"></i></button></div>` : ''}
                </div>
            `;
            html += `</div>`;
            appContent.innerHTML = html;
        }

        function renderWeather() {
            setActiveTab('weather');
            const LOCS = [
                { name: "札幌", en: "Sapporo", temp: "-3°", rain: "10%", snow: "80%", icon: "snowflake" },
                { name: "洞爺湖", en: "Lake Toya", temp: "-1°", rain: "20%", snow: "60%", icon: "cloud-showers-heavy" },
                { name: "旭川", en: "Asahikawa", temp: "-8°", rain: "0%", snow: "90%", icon: "snowflake" },
                { name: "小樽", en: "Otaru", temp: "-2°", rain: "30%", snow: "70%", icon: "cloud-meatball" }
            ];
            appContent.innerHTML = `
                <div class="fade-in pb-10">
                    <h2 class="font-serif text-3xl font-bold text-ink mb-6">Snow Forecast</h2>
                    <div class="grid grid-cols-1 gap-4 mb-8">
                        ${LOCS.map(loc => `
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 flex items-center justify-between">
                                <div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-stone-50 flex items-center justify-center text-stone-400 text-xl"><i class="fa-solid fa-${loc.icon}"></i></div><div><div class="font-serif text-lg font-bold text-ink">${loc.name}</div><div class="text-[10px] text-stone-400 uppercase tracking-widest">${loc.en}</div></div></div>
                                <div class="text-right"><div class="text-2xl font-mono font-bold text-ink mb-1">${loc.temp}</div><div class="flex gap-2 text-[10px] font-mono text-stone-500"><span class="flex items-center"><i class="fa-solid fa-droplet mr-1 text-blue-300"></i>${loc.rain}</span><span class="flex items-center"><i class="fa-solid fa-snowflake mr-1 text-stone-300"></i>${loc.snow}</span></div></div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Live Cameras Section -->
                    <h2 class="font-serif text-3xl font-bold text-ink mb-4">Live Cameras</h2>
                    <div class="grid grid-cols-2 gap-3 mb-8">
                         <a href="https://www.youtube.com/watch?v=RBHsITnIoI0" target="_blank" class="bg-white border border-stone-200 rounded-xl p-3 flex flex-col items-center text-center hover:border-red-500 transition-all">
                             <i class="fa-brands fa-youtube text-2xl text-red-500 mb-2"></i>
                             <div class="text-xs font-bold text-ink">札幌大通公園</div>
                         </a>
                         <a href="https://www.youtube.com/watch?v=74OOcuVMDzE" target="_blank" class="bg-white border border-stone-200 rounded-xl p-3 flex flex-col items-center text-center hover:border-red-500 transition-all">
                             <i class="fa-brands fa-youtube text-2xl text-red-500 mb-2"></i>
                             <div class="text-xs font-bold text-ink">小樽運河</div>
                         </a>
                         <a href="https://www.youtube.com/watch?v=FmtX2lJLoJY" target="_blank" class="bg-white border border-stone-200 rounded-xl p-3 flex flex-col items-center text-center hover:border-red-500 transition-all">
                             <i class="fa-brands fa-youtube text-2xl text-red-500 mb-2"></i>
                             <div class="text-xs font-bold text-ink">藻岩山</div>
                         </a>
                         <a href="https://www.youtube.com/watch?v=CF1vS8DdBIk" target="_blank" class="bg-white border border-stone-200 rounded-xl p-3 flex flex-col items-center text-center hover:border-red-500 transition-all">
                             <i class="fa-brands fa-youtube text-2xl text-red-500 mb-2"></i>
                             <div class="text-xs font-bold text-ink">狸小路</div>
                         </a>
                         <a href="https://www.youtube.com/watch?v=0NAE8CwRQ68" target="_blank" class="bg-white border border-stone-200 rounded-xl p-3 flex flex-col items-center text-center hover:border-red-500 transition-all">
                             <i class="fa-brands fa-youtube text-2xl text-red-500 mb-2"></i>
                             <div class="text-xs font-bold text-ink">旭川</div>
                         </a>
                    </div>

                    <h2 class="font-serif text-3xl font-bold text-ink mb-6">官方即時資訊連結</h2>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <a href="https://www.jrhokkaido.co.jp/global/chinese/" target="_blank" class="bg-stone-800 text-white p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-black transition-colors"><i class="fa-solid fa-train text-2xl"></i><span class="text-xs font-bold tracking-wider">JR 北海道運行</span></a>
                        <a href="https://www.hokkaido-airports.com/zh-CHT/new-chitose/airport/fis/" target="_blank" class="bg-stone-800 text-white p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-black transition-colors"><i class="fa-solid fa-plane-departure text-2xl"></i><span class="text-xs font-bold tracking-wider">新千歲航班</span></a>
                        <a href="https://www.jma.go.jp/bosai/warning/#area_type=offices&area_code=016000&lang=zh_tw" target="_blank" class="bg-stone-800 text-white p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-black transition-colors"><i class="fa-solid fa-cloud-bolt text-2xl"></i><span class="text-xs font-bold tracking-wider">氣象廳警報</span></a>
                    </div>

                    <h2 class="font-serif text-3xl font-bold text-ink mb-6 mt-8">緊急聯絡與救援</h2>
                    <div class="space-y-3">
                        <div class="bg-red-50 border border-red-100 p-4 rounded-xl flex justify-between items-center"><div><div class="font-bold text-red-800">緊急報案 (警察)</div><div class="text-xs text-red-600">Police</div></div><a href="tel:110" class="bg-red-500 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-red-600 transition-colors"><i class="fa-solid fa-phone mr-1"></i> 110</a></div>
                        <div class="bg-red-50 border border-red-100 p-4 rounded-xl flex justify-between items-center"><div><div class="font-bold text-red-800">火警 / 救護車</div><div class="text-xs text-red-600">Fire / Ambulance</div></div><a href="tel:119" class="bg-red-500 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-red-600 transition-colors"><i class="fa-solid fa-phone mr-1"></i> 119</a></div>
                        <div class="bg-white border border-stone-200 p-4 rounded-xl shadow-sm"><div class="flex items-start gap-3 mb-2"><div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-building-flag"></i></div><div><div class="font-bold text-ink">台北駐日經濟文化代表處 (札幌分處)</div><div class="text-xs text-stone-500">遺失護照、急難救助</div></div></div><div class="pl-13 space-y-2"><a href="tel:+81-11-222-2930" class="block text-sm text-stone-600 hover:text-bronze"><i class="fa-solid fa-phone mr-2 w-4"></i> 011-222-2930 (上班時間)</a><a href="tel:+81-80-1460-2568" class="block text-sm text-red-500 hover:text-red-700 font-bold"><i class="fa-solid fa-mobile-screen mr-2 w-4"></i> 080-1460-2568 (緊急聯絡)</a><a href="https://maps.app.goo.gl/6QxJ8Z8Q8Q8Q8Q8Q8" target="_blank" class="block text-xs text-stone-400 hover:text-stone-600 mt-1"><i class="fa-solid fa-location-dot mr-2 w-4"></i> 札幌市中央區北4條西4丁目1番地 伊藤大樓5樓</a></div></div>
                        <div class="bg-white border border-stone-200 p-4 rounded-xl shadow-sm flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-stone-100 text-stone-500 rounded-full flex items-center justify-center"><i class="fa-solid fa-headset"></i></div><div><div class="font-bold text-ink">日本旅遊諮詢熱線</div><div class="text-xs text-stone-500">JNTO (24小時/中英日)</div></div></div><a href="tel:050-3816-2787" class="text-stone-400 hover:text-ink text-xl"><i class="fa-solid fa-phone"></i></a></div>
                    </div>
                </div>
            `;
        }

        function renderLists() {
            setActiveTab('lists');
            
            // Filter and Calculations for Shopping List
            const shoppingTotal = shoppingList.reduce((acc, item) => acc + (item.price || 0), 0);

            let html = `
                <div class="fade-in pb-20">
                    <div class="flex justify-center mb-6 border-b border-stone-200">
                        <button onclick="switchListTab('packing')" class="px-6 py-2 text-sm font-bold uppercase tracking-widest border-b-2 transition-colors ${activeListTab === 'packing' ? 'border-bronze text-ink' : 'border-transparent text-stone-400'}">Packing</button>
                        <button onclick="switchListTab('shopping')" class="px-6 py-2 text-sm font-bold uppercase tracking-widest border-b-2 transition-colors ${activeListTab === 'shopping' ? 'border-bronze text-ink' : 'border-transparent text-stone-400'}">Shopping</button>
                    </div>
            `;

            if (activeListTab === 'packing') {
                html += `
                    <div class="text-xs text-stone-400 mb-4 font-mono tracking-widest text-center">WINTER ESSENTIALS</div>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="new-checklist-item" placeholder="Add new item..." class="flex-1 bg-white border-b border-stone-300 py-2 px-3 focus:border-bronze outline-none text-sm font-serif rounded">
                        <button onclick="addChecklistItem()" class="bg-bronze text-white w-10 h-10 rounded flex items-center justify-center hover:bg-[#7a6145] transition-colors shadow-sm"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="space-y-2 mb-8">
                        ${checklist.map((item, index) => `
                            <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-white transition-colors group relative border border-transparent hover:border-stone-100">
                                <div class="relative flex items-center mt-1 cursor-pointer">
                                    <input type="checkbox" onchange="toggleCheck(${index})" class="peer appearance-none w-5 h-5 border border-stone-300 rounded checked:bg-bronze checked:border-bronze transition-all" ${item.done ? 'checked' : ''}>
                                    <i class="fa-solid fa-check text-white text-xs absolute left-1 top-1 opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                </div>
                                <span class="flex-1 text-sm font-light text-ink leading-relaxed ${item.done ? 'line-through text-stone-300 decoration-stone-300' : ''}">${item.text}</span>
                                <button onclick="openConfirmModal('Delete this item?', () => deleteChecklistItem(${index}))" class="text-stone-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100 px-2"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Shopping List Render
                 html += `
                    <div class="text-xs text-stone-400 mb-4 font-mono tracking-widest text-center">SOUVENIRS & GIFTS</div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 mb-6">
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="new-shop-item" placeholder="Item name..." class="flex-[2] bg-stone-50 border-b border-stone-300 py-2 px-3 focus:border-bronze outline-none text-sm font-serif rounded">
                            <input type="number" id="new-shop-price" placeholder="¥ Est." class="flex-1 bg-stone-50 border-b border-stone-300 py-2 px-3 focus:border-bronze outline-none text-sm font-serif rounded">
                        </div>
                        <button onclick="addShoppingItem()" class="w-full bg-ink text-white py-2 rounded text-xs uppercase font-bold tracking-widest hover:bg-black">Add to List</button>
                    </div>

                    <div class="space-y-2 mb-6">
                        ${shoppingList.map((item, index) => `
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-white border border-stone-100 shadow-sm group">
                                <div class="relative flex items-center cursor-pointer">
                                    <input type="checkbox" onchange="toggleShopCheck(${index})" class="peer appearance-none w-5 h-5 border border-stone-300 rounded checked:bg-accent checked:border-accent transition-all" ${item.done ? 'checked' : ''}>
                                    <i class="fa-solid fa-check text-white text-xs absolute left-1 top-1 opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-serif text-ink ${item.done ? 'line-through text-stone-300' : ''}">${item.text}</div>
                                </div>
                                <div class="text-xs font-mono text-stone-500">¥${(item.price || 0).toLocaleString()}</div>
                                <button onclick="openConfirmModal('Delete shopping item?', () => deleteShoppingItem(${index}))" class="text-stone-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        `).join('')}
                        ${shoppingList.length === 0 ? '<div class="text-center text-stone-300 text-xs py-4">No items yet.</div>' : ''}
                    </div>

                    <div class="bg-stone-100 p-4 rounded-xl flex justify-between items-center">
                        <span class="text-xs font-bold text-stone-500 uppercase tracking-widest">Estimated Total</span>
                        <span class="text-xl font-serif font-bold text-ink">¥ ${shoppingTotal.toLocaleString()}</span>
                    </div>
                 `;
            }

            html += `
            <!-- Memo Pad -->
            <div class="bg-white rounded-lg shadow-sm border border-stone-100 overflow-hidden mt-8">
                <div class="bg-[#F9F8F6] px-4 py-2 border-b border-stone-100 flex items-center justify-between">
                    <span class="text-xs font-bold text-stone-400 uppercase tracking-widest">MEMO / NOTES</span>
                    <i class="fa-regular fa-note-sticky text-stone-300"></i>
                </div>
                <textarea id="memo-pad" oninput="saveMemos(this.value)" class="w-full h-48 p-4 text-sm font-serif text-ink leading-relaxed resize-none outline-none bg-transparent" placeholder="Type your notes here...">${memos}</textarea>
            </div>
            </div>`;
            appContent.innerHTML = html;
        }

        function renderWallet() {
            setActiveTab('wallet');
            const cashSpent = expenses.filter(e => e.method === 'cash').reduce((a, c) => a + c.amount, 0);
            const cardSpent = expenses.filter(e => e.method === 'card').reduce((a, c) => a + c.amount, 0);
            const suicaSpent = expenses.filter(e => e.method === 'suica').reduce((a, c) => a + c.amount, 0);
            const totalSpent = cashSpent + cardSpent + suicaSpent;
            const currentCash = initialBudget - cashSpent;
            const filteredExpenses = expenses.slice().reverse().filter(e => currentWalletFilter === 'all' || e.method === currentWalletFilter);

            appContent.innerHTML = `
                <div class="fade-in pb-10">
                    <div class="bg-white rounded-2xl shadow-sm border border-stone-100 p-5 mb-6 relative overflow-hidden">
                        <div class="h-1 bg-accent absolute top-0 left-0 right-0"></div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-serif text-xl font-bold text-ink flex items-center gap-2"><i class="fa-solid fa-calculator text-accent"></i> Quick Converter</h2>
                            <button onclick="openRateModal()" class="text-[10px] border border-stone-300 hover:border-bronze hover:text-bronze px-2 py-1 rounded transition-colors flex items-center gap-1"><i class="fa-solid fa-rotate"></i> 抓取線上匯率</button>
                        </div>
                        <div class="flex items-center justify-between gap-4 mb-2">
                             <div class="flex-1 relative"><span class="absolute left-0 top-1/2 -translate-y-1/2 text-stone-300 text-lg">¥</span><input type="text" id="converter-input" oninput="calculateConverter()" placeholder="JPY Amount" class="w-full pl-6 py-2 text-xl font-serif text-ink border-b border-stone-200 focus:border-accent outline-none bg-transparent placeholder-stone-200"></div>
                             <i class="fa-solid fa-arrow-right text-stone-300"></i>
                             <div class="text-right"><div class="text-2xl font-display font-bold text-accent" id="converter-output">NT$ 0</div></div>
                        </div>
                        <div class="text-right text-[10px] text-stone-400 font-mono">Rate: <span id="display-rate">${exchangeRate.toFixed(3)}</span></div>
                    </div>

                    <div class="bg-[#1A1A1A] rounded-2xl shadow-float p-6 text-white relative overflow-hidden mb-6">
                        <div class="absolute -right-4 -bottom-4 text-9xl text-white/5"><i class="fa-solid fa-yen-sign"></i></div>
                        
                        <!-- Top Right Edit Button -->
                        <button onclick="openBudgetModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                        <button onclick="openBudgetModal()" class="absolute top-4 right-4 text-[10px] border border-stone-600 px-2 py-1 rounded hover:bg-stone-800 transition-colors bg-stone-900/50 backdrop-blur-sm">
                            <i class="fa-solid fa-pen mr-1"></i> 設定初始金額
                        </button>

                        <div class="mb-8 mt-2">
                            <div class="text-[10px] text-stone-400 uppercase tracking-widest mb-1">CASH BALANCE (ON HAND)</div>
                            <div class="text-5xl font-display font-light tracking-wide">¥ ${currentCash.toLocaleString()}</div>
                        </div>
                        
                        <div class="flex justify-between items-end border-t border-white/10 pt-4">
                            <div>
                                <div class="text-[9px] text-stone-500 uppercase tracking-widest mb-1">INITIAL CASH</div>
                                <div class="font-mono text-sm tracking-wider">¥ ${initialBudget.toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[9px] text-stone-500 uppercase tracking-widest mb-1">TOTAL SPENT</div>
                                <div class="font-mono text-sm tracking-wider">¥ ${totalSpent.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                         <div class="bg-white p-3 rounded-xl border border-stone-100 shadow-sm"><div class="text-[9px] text-stone-400 uppercase font-bold mb-1">Total Spent</div><div class="font-mono font-bold text-ink">¥${totalSpent.toLocaleString()}</div></div>
                         <div class="bg-white p-3 rounded-xl border border-stone-100 shadow-sm"><div class="text-[9px] text-yellow-600 uppercase font-bold mb-1">Cash Spent</div><div class="font-mono text-stone-600">¥${cashSpent.toLocaleString()}</div></div>
                         <div class="bg-white p-3 rounded-xl border border-stone-100 shadow-sm"><div class="text-[9px] text-blue-600 uppercase font-bold mb-1">Card Spent</div><div class="font-mono text-stone-600">¥${cardSpent.toLocaleString()}</div></div>
                         <div class="bg-white p-3 rounded-xl border border-stone-100 shadow-sm"><div class="text-[9px] text-green-600 uppercase font-bold mb-1">Suica Spent</div><div class="font-mono text-stone-600">¥${suicaSpent.toLocaleString()}</div></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-stone-100 p-5 mb-8">
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <input type="text" id="expense-name" placeholder="Item Name" class="wallet-input flex-[2]">
                            <div class="flex items-center flex-1 relative"><span class="text-stone-300 mr-2">¥</span><input type="number" id="expense-amount" placeholder="Price" class="wallet-input w-full"></div>
                        </div>
                        <div class="flex gap-2 mb-6">
                            <button id="btn-pay-cash" onclick="setPaymentMethod('cash')" class="flex-1 py-2.5 rounded border transition-all flex items-center justify-center gap-2 text-sm ${currentPaymentMethod === 'cash' ? 'bg-ink text-paper border-ink' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-400'}"><i class="fa-solid fa-coins"></i> Cash</button>
                            <button id="btn-pay-card" onclick="setPaymentMethod('card')" class="flex-1 py-2.5 rounded border transition-all flex items-center justify-center gap-2 text-sm ${currentPaymentMethod === 'card' ? 'bg-ink text-paper border-ink' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-400'}"><i class="fa-regular fa-credit-card"></i> Card</button>
                            <button id="btn-pay-suica" onclick="setPaymentMethod('suica')" class="flex-1 py-2.5 rounded border transition-all flex items-center justify-center gap-2 text-sm ${currentPaymentMethod === 'suica' ? 'bg-ink text-paper border-ink' : 'bg-white text-stone-400 border-stone-200 hover:border-stone-400'}"><i class="fa-solid fa-train"></i> Suica</button>
                        </div>
                        <button onclick="addExpense()" class="w-full bg-[#8C7051] text-white py-3 rounded font-bold tracking-wide hover:bg-[#7a6145] transition-colors shadow-lg shadow-orange-900/10">ADD EXPENSE</button>
                    </div>

                    <div class="mb-4 flex items-center justify-between"><h3 class="font-bold text-ink text-sm">History</h3><div class="flex bg-stone-200/50 p-1 rounded-lg">${['all', 'cash', 'card', 'suica'].map(t => `<button onclick="setFilter('${t}')" class="px-3 py-1 text-[10px] uppercase font-bold rounded-md transition-all ${currentWalletFilter === t ? 'bg-white text-ink shadow-sm' : 'text-stone-400 hover:text-stone-600'}">${t}</button>`).join('')}</div></div>
                    <div class="space-y-3">${filteredExpenses.map(e => {
                        let iconClass, iconBg;
                        if (e.method === 'cash') { iconClass = 'fa-coins text-yellow-600'; iconBg = 'bg-yellow-50'; }
                        else if (e.method === 'card') { iconClass = 'fa-credit-card text-blue-600'; iconBg = 'bg-blue-50'; }
                        else { iconClass = 'fa-train text-green-600'; iconBg = 'bg-green-50'; }
                        return `
                        <div class="flex justify-between items-center py-3 border-b border-stone-200/50 group">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full ${iconBg} flex items-center justify-center ${iconClass} text-sm">
                                    <i class="fa-solid ${e.method === 'card' ? 'fa-regular fa-credit-card' : (e.method === 'suica' ? 'fa-train' : 'fa-coins')}"></i>
                                </div>
                                <div>
                                    <div class="font-serif text-ink">${e.desc}</div>
                                    <div class="text-[10px] text-stone-400 font-mono">${new Date(e.date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <div class="font-mono text-ink">¥${e.amount.toLocaleString()}</div>
                                    <div class="text-[10px] text-stone-400">NT$ ${Math.round(e.amount * exchangeRate).toLocaleString()}</div>
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openEditExpenseModal(${e.id})" class="text-stone-300 hover:text-ink text-xs p-1"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="openConfirmModal('Delete this expense record?', () => deleteExpense(${e.id}))" class="text-stone-300 hover:text-red-500 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>`
                    }).join('') || '<div class="text-center text-stone-300 text-sm py-10 italic">No records found.</div>'}</div>
                </div>
            `;
        }

        function renderDocs() {
            setActiveTab('docs');
            appContent.innerHTML = `
                <div class="fade-in pb-10">
                    <div class="mb-2">
                        <div class="text-[10px] font-bold text-accent uppercase tracking-widest mb-1"><span class="w-2 h-2 bg-accent rounded-full inline-block mr-2"></span>WINTER JOURNEY</div>
                        <h2 class="font-serif text-4xl font-light text-ink mb-1">2025</h2>
                        <h2 class="font-serif text-3xl text-ink">北海道</h2>
                    </div>
                    <div class="text-xs text-stone-400 border-b border-stone-200 pb-4 mb-6">票券、預約單、電子憑證集中管理</div>
                    <button onclick="openAddDocModal()" class="w-full py-4 border border-dashed border-[#8C7051] rounded-lg bg-[#F2F0E9] text-[#8C7051] font-serif text-lg mb-8 hover:bg-[#eae6db] transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Add New Record</button>
                    <div class="space-y-4">
                        ${documents.map((doc, index) => `
                            <div class="bg-white rounded-l border-l-4 border-bronze shadow-sm p-5 relative overflow-hidden group hover:shadow-md transition-all cursor-pointer" onclick="openEditDocModal(${index})">
                                <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="openEditDocModal(${index}); event.stopPropagation();" class="text-stone-400 hover:text-ink"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="openConfirmModal('Delete this document?', () => deleteDoc(${index})); event.stopPropagation();" class="text-stone-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-full bg-paper flex items-center justify-center text-xl text-ink"><i class="fa-solid ${getDocIcon(doc.type)}"></i></div>
                                    <div class="flex-1">
                                        <div class="text-[10px] text-stone-400 font-bold uppercase tracking-widest mb-1">${doc.type}</div>
                                        <h3 class="font-serif text-2xl text-ink mb-2">${doc.title}</h3>
                                        ${doc.bookingId ? `<div class="inline-block border border-stone-200 rounded px-2 py-0.5 text-[10px] text-stone-500 font-mono bg-stone-50 mb-3">BOOKING ID: <span class="text-ink font-bold">${doc.bookingId}</span></div>` : ''}
                                        <div>
                                            <button ${doc.link ? `onclick="window.open('${doc.link}', '_blank'); event.stopPropagation();"` : `onclick="alert('No link attached'); event.stopPropagation();"`} class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1 transition-colors">
                                                <i class="fa-solid fa-link"></i> Open File / Link
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- MODAL CONTENT FUNCTIONS ---

        function openEditEventModal(dayIndex, eventIndex) {
            const event = itinerary[dayIndex].events[eventIndex];
            showModal(`
                <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="w-8 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                <h2 class="font-serif text-3xl text-ink mb-6 italic border-b border-stone-200 pb-2">Edit Event</h2>
                <div class="flex gap-4 mb-6">
                    <div class="flex-1"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Time</label><input type="time" id="edit-time" value="${event.time}" class="w-full text-xl font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                    <div class="flex-1"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Day (Move)</label><select id="edit-day" class="w-full text-lg font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent appearance-none">${itinerary.map((d, i) => `<option value="${i}" ${i === dayIndex ? 'selected' : ''}>Day ${d.day} (${d.date})</option>`).join('')}</select></div>
                </div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Type</label><select id="edit-type" class="w-full text-lg font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent" onchange="toggleTransportFields()"><option value="sight" ${event.type === 'sight' ? 'selected' : ''}>Sightseeing</option><option value="food" ${event.type === 'food' ? 'selected' : ''}>Food / Restaurant</option><option value="transport" ${event.type === 'transport' ? 'selected' : ''}>Transport</option><option value="hotel" ${event.type === 'hotel' ? 'selected' : ''}>Hotel</option><option value="flight" ${event.type === 'flight' ? 'selected' : ''}>Flight</option></select></div>
                <div class="bg-stone-50 p-3 rounded-lg mb-6 flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bookingStatus" value="flexible" ${event.bookingStatus !== 'fixed' ? 'checked' : ''} class="accent-bronze"><span class="text-sm text-stone-600">Flexible</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bookingStatus" value="fixed" ${event.bookingStatus === 'fixed' ? 'checked' : ''} class="accent-bronze"><span class="text-sm font-bold text-ink">Fixed / Booked</span></label></div>
                <div id="transport-fields" class="${event.type === 'transport' ? '' : 'hidden'} border border-stone-200 rounded-lg p-4 mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Transport Mode</label><select id="edit-transport-type" class="w-full text-base border-b border-stone-200 pb-1 mb-3 bg-transparent"><option value="train" ${event.transportType === 'train' ? 'selected' : ''}>Train / Subway</option><option value="bus" ${event.transportType === 'bus' ? 'selected' : ''}>Bus</option><option value="walk" ${event.transportType === 'walk' ? 'selected' : ''}>Walk</option><option value="charter" ${event.transportType === 'charter' ? 'selected' : ''}>Charter / Taxi</option><option value="flight" ${event.transportType === 'flight' ? 'selected' : ''}>Flight</option></select><input type="text" id="edit-transport-route" value="${event.transportRoute || ''}" placeholder="Route (e.g. Hotel -> Station)" class="w-full text-sm border-b border-stone-200 pb-1 bg-transparent"></div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Event Title</label><input type="text" id="edit-title" value="${event.title}" class="w-full text-2xl font-serif font-bold text-ink border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                
                <div class="mb-6">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.title + ' Hokkaido')}" target="_blank" class="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-medium border border-blue-100 bg-blue-50 px-3 py-2 rounded-lg transition-colors">
                        <i class="fa-solid fa-map-location-dot"></i> View on Google Maps
                    </a>
                </div>

                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Opening Hours</label><input type="text" id="edit-hours" value="${event.openingHours || ''}" placeholder="e.g. 09:00 - 18:00" class="w-full text-sm font-mono text-stone-500 border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Description</label><textarea id="edit-desc" rows="3" class="w-full text-base text-stone-600 border-b border-stone-300 focus:border-bronze outline-none bg-transparent resize-none">${event.desc}</textarea></div>
                <div class="mb-8 flex flex-col gap-3">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="w-5 h-5 border-2 border-stone-300 rounded-full flex items-center justify-center transition-colors group-hover:border-accent"><div class="w-2.5 h-2.5 rounded-full bg-accent opacity-0 transition-opacity ${event.important ? 'opacity-100' : ''}" id="important-indicator"></div></div>
                        <input type="checkbox" id="edit-important" class="hidden" ${event.important ? 'checked' : ''} onchange="document.getElementById('important-indicator').classList.toggle('opacity-100')">
                        <span class="text-sm text-stone-500 group-hover:text-accent transition-colors">Highlight this event</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="w-5 h-5 border-2 border-stone-300 rounded-full flex items-center justify-center transition-colors group-hover:border-bronze"><div class="w-2.5 h-2.5 rounded-full bg-bronze opacity-0 transition-opacity ${event.showMap ? 'opacity-100' : ''}" id="map-indicator"></div></div>
                        <input type="checkbox" id="edit-showMap" class="hidden" ${event.showMap ? 'checked' : ''} onchange="document.getElementById('map-indicator').classList.toggle('opacity-100')">
                        <span class="text-sm text-stone-500 group-hover:text-bronze transition-colors">Show Google Map Button</span>
                    </label>
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-stone-100"><button onclick="openConfirmModal('Delete this event?', () => deleteEvent(${dayIndex}, ${eventIndex}))" class="text-xs text-red-400 hover:text-red-600 uppercase tracking-widest font-bold px-2 py-2">Delete</button><button onclick="saveEvent(${dayIndex}, ${eventIndex})" class="bg-ink text-white px-8 py-3 rounded shadow-lg hover:bg-black transition-transform active:scale-95 font-serif italic text-lg">Save Changes</button></div>
            `);
        }

        function openAddEventModal(dayIndex) {
            showModal(`
                <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="w-8 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                <h2 class="font-serif text-3xl text-ink mb-6 italic border-b border-stone-200 pb-2">Add Event</h2>
                <div class="flex gap-4 mb-6">
                    <div class="flex-1"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Time</label><input type="time" id="edit-time" value="09:00" class="w-full text-xl font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                    <div class="flex-1"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Day</label><select id="edit-day" class="w-full text-lg font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent appearance-none">${itinerary.map((d, i) => `<option value="${i}" ${i === dayIndex ? 'selected' : ''}>Day ${d.day} (${d.date})</option>`).join('')}</select></div>
                </div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Type</label><select id="edit-type" class="w-full text-lg font-serif border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent" onchange="toggleTransportFields()"><option value="sight" selected>Sightseeing</option><option value="food">Food / Restaurant</option><option value="transport">Transport</option><option value="hotel">Hotel</option></select></div>
                <div class="bg-stone-50 p-3 rounded-lg mb-6 flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bookingStatus" value="flexible" checked class="accent-bronze"><span class="text-sm text-stone-600">Flexible</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="bookingStatus" value="fixed" class="accent-bronze"><span class="text-sm font-bold text-ink">Fixed / Booked</span></label></div>
                <div id="transport-fields" class="hidden border border-stone-200 rounded-lg p-4 mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Transport Mode</label><select id="edit-transport-type" class="w-full text-base border-b border-stone-200 pb-1 mb-3 bg-transparent"><option value="train">Train / Subway</option><option value="bus">Bus</option><option value="walk">Walk</option><option value="charter">Charter / Taxi</option></select><input type="text" id="edit-transport-route" placeholder="Route" class="w-full text-sm border-b border-stone-200 pb-1 bg-transparent"></div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Event Title</label><input type="text" id="edit-title" placeholder="New Event" class="w-full text-2xl font-serif font-bold text-ink border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Opening Hours</label><input type="text" id="edit-hours" placeholder="e.g. 09:00 - 18:00" class="w-full text-sm font-mono text-stone-500 border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent"></div>
                <div class="mb-6"><label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">Description</label><textarea id="edit-desc" rows="3" placeholder="Add details..." class="w-full text-base text-stone-600 border-b border-stone-300 focus:border-bronze outline-none bg-transparent resize-none"></textarea></div>
                <div class="mb-8 flex flex-col gap-3">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="w-5 h-5 border-2 border-stone-300 rounded-full flex items-center justify-center transition-colors group-hover:border-accent"><div class="w-2.5 h-2.5 rounded-full bg-accent opacity-0 transition-opacity" id="important-indicator"></div></div>
                        <input type="checkbox" id="edit-important" class="hidden" onchange="document.getElementById('important-indicator').classList.toggle('opacity-100')">
                        <span class="text-sm text-stone-500 group-hover:text-accent transition-colors">Highlight this event</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="w-5 h-5 border-2 border-stone-300 rounded-full flex items-center justify-center transition-colors group-hover:border-bronze"><div class="w-2.5 h-2.5 rounded-full bg-bronze opacity-0 transition-opacity" id="map-indicator"></div></div>
                        <input type="checkbox" id="edit-showMap" class="hidden" onchange="document.getElementById('map-indicator').classList.toggle('opacity-100')">
                        <span class="text-sm text-stone-500 group-hover:text-bronze transition-colors">Show Google Map Button</span>
                    </label>
                </div>
                <div class="flex justify-end items-center pt-4 border-t border-stone-100"><button onclick="createNewEvent()" class="bg-ink text-white px-8 py-3 rounded shadow-lg hover:bg-black transition-transform active:scale-95 font-serif italic text-lg">Add Event</button></div>
            `);
        }

        function openAddDocModal() {
            openEditDocModal(null);
        }

        function openEditDocModal(index) {
            const isEdit = index !== null;
            const doc = isEdit ? documents[index] : { type: 'flight', title: '', bookingId: '', link: '' };
            
            showModal(`
                 <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                 <div class="w-8 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                 <h2 class="font-serif text-3xl text-ink mb-2 italic">${isEdit ? 'Edit Document' : 'Add Document'}</h2>
                 <hr class="border-stone-200 mb-6">
                 
                 <label class="text-[10px] font-bold text-stone-400 uppercase mb-2 block">CATEGORY</label>
                 <div class="grid grid-cols-5 gap-2 mb-6">
                    ${['flight', 'hotel', 'food', 'skiing', 'file'].map(t => `
                        <div onclick="selectDocType(this, '${t}')" class="doc-type-btn cursor-pointer flex flex-col items-center justify-center p-2 rounded-lg bg-stone-50 hover:bg-stone-100 border border-transparent hover:border-bronze transition-all ${t === doc.type ? 'bg-[#8C7051] text-white' : 'text-stone-400'}">
                            <i class="fa-solid ${getDocIcon(t)} text-xl mb-1"></i>
                            <span class="text-[8px] uppercase font-bold tracking-widest">${t === 'file' ? 'OTHER' : t.toUpperCase()}</span>
                        </div>
                    `).join('')}
                    <input type="hidden" id="doc-type" value="${doc.type}">
                 </div>

                 <div class="mb-6">
                    <label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">TITLE</label>
                    <input type="text" id="doc-title" value="${doc.title}" placeholder="e.g. CI130 E-Ticket" class="w-full text-2xl font-serif font-bold text-ink border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent">
                 </div>

                 <div class="mb-6">
                    <label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">BOOKING REF / ID (OPTIONAL)</label>
                    <input type="text" id="doc-id" value="${doc.bookingId || ''}" placeholder="#12345678" class="w-full text-lg font-mono text-stone-600 bg-stone-100 rounded px-3 py-2 border-none focus:ring-1 focus:ring-bronze">
                 </div>

                 <div class="mb-8">
                    <label class="text-[10px] font-bold text-stone-400 uppercase mb-1 block">LINK TO FILE</label>
                    <input type="text" id="doc-link" value="${doc.link || ''}" placeholder="https://..." class="w-full text-base font-serif text-stone-500 border-b border-stone-300 pb-1 focus:border-bronze outline-none bg-transparent">
                    <div class="text-[10px] text-stone-300 mt-1">* 建議將 PDF 上傳至雲端硬碟，在此貼上分享連結。</div>
                 </div>

                 <button onclick="saveDoc(${isEdit ? index : -1})" class="w-full bg-ink text-white py-4 rounded shadow-lg hover:bg-black transition-transform active:scale-95 font-serif italic text-lg">Save Record</button>
            `);
        }
        
        function selectDocType(el, type) {
            document.querySelectorAll('.doc-type-btn').forEach(b => {
                b.classList.remove('bg-[#8C7051]', 'text-white');
                b.classList.add('bg-stone-50', 'text-stone-400');
            });
            el.classList.remove('bg-stone-50', 'text-stone-400');
            el.classList.add('bg-[#8C7051]', 'text-white');
            document.getElementById('doc-type').value = type;
        }

        function saveDoc(index) {
            const title = document.getElementById('doc-title').value;
            if(!title) return alert('Title is required');
            
            const docData = {
                id: index !== -1 ? documents[index].id : Date.now(),
                title: title,
                type: document.getElementById('doc-type').value,
                bookingId: document.getElementById('doc-id').value,
                link: document.getElementById('doc-link').value
            };

            if (index !== -1) {
                documents[index] = docData;
            } else {
                documents.push(docData);
            }
            
            saveAll();
            closeModal();
            renderDocs();
        }

        function deleteDoc(index) {
            documents.splice(index, 1);
            saveAll();
            renderDocs();
            closeModal(); // Close confirm modal
        }

        function openBudgetModal() {
            showModal(`
                <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="w-8 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                <h2 class="font-serif text-3xl text-ink mb-4 italic text-center">Initial Cash</h2>
                <hr class="w-16 mx-auto border-stone-300 mb-6">
                
                <div class="mb-8 text-center">
                    <label class="text-[10px] font-bold text-stone-400 uppercase mb-2 block tracking-widest">TOTAL JPY CASH</label>
                    <input type="number" id="budget-input" value="${initialBudget}" class="w-full text-5xl font-serif text-center border-b border-stone-200 py-2 focus:border-bronze outline-none bg-transparent font-bold text-ink">
                    <div class="text-[10px] text-stone-400 mt-4">請輸入您這次旅行攜帶的日幣現金總額，用於計算剩餘現金。</div>
                </div>
                <button onclick="saveBudget()" class="w-full bg-ink text-white py-4 rounded shadow-lg hover:bg-black transition-transform active:scale-95 font-serif italic text-lg">Save Budget</button>
            `);
        }

        function openRateModal() {
            showModal(`
                <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                <div class="text-center py-8">
                    <div class="mb-4"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-bronze"></i></div>
                    <h3 class="font-serif text-xl text-ink mb-2">Fetching Live Rate...</h3>
                    <p class="text-xs text-stone-400">Connecting to currency exchange service</p>
                </div>
            `);
            setTimeout(() => {
                const newRate = 0.20 + (Math.random() * 0.02);
                exchangeRate = newRate;
                saveAll();
                showModal(`
                    <button onclick="closeModal()" class="absolute top-0 right-0 p-4 text-stone-400 hover:text-ink transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <div class="text-center py-4">
                        <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-check"></i></div>
                        <h3 class="font-serif text-2xl text-ink mb-1">Rate Updated</h3>
                        <div class="text-4xl font-mono font-bold text-bronze my-4">${newRate.toFixed(4)}</div>
                        <p class="text-xs text-stone-400 mb-6">Current JPY to TWD exchange rate</p>
                        <button onclick="closeModal(); renderWallet();" class="w-full bg-ink text-white py-3 rounded-lg">Done</button>
                    </div>
                `);
            }, 1000);
        }

        // --- DATA SAVING & LOGIC ---

        function toggleTransportFields() {
            const type = document.getElementById('edit-type').value;
            const fields = document.getElementById('transport-fields');
            if (type === 'transport') fields.classList.remove('hidden'); else fields.classList.add('hidden');
        }

        function saveEvent(originalDayIndex, eventIndex) {
            const newDayIndex = parseInt(document.getElementById('edit-day').value);
            const updatedEvent = {
                id: Date.now(),
                time: document.getElementById('edit-time').value,
                title: document.getElementById('edit-title').value,
                desc: document.getElementById('edit-desc').value,
                type: document.getElementById('edit-type').value,
                bookingStatus: document.querySelector('input[name="bookingStatus"]:checked').value,
                important: document.getElementById('edit-important').checked,
                showMap: document.getElementById('edit-showMap').checked,
                openingHours: document.getElementById('edit-hours').value,
                transportType: document.getElementById('edit-type').value === 'transport' ? document.getElementById('edit-transport-type').value : null,
                transportRoute: document.getElementById('edit-type').value === 'transport' ? document.getElementById('edit-transport-route').value : null
            };
            itinerary[originalDayIndex].events.splice(eventIndex, 1);
            itinerary[newDayIndex].events.push(updatedEvent);
            itinerary[newDayIndex].events.sort((a, b) => a.time.localeCompare(b.time));
            saveAll();
            closeModal();
            originalDayIndex !== newDayIndex ? switchDay(newDayIndex) : renderPlan();
        }

        function createNewEvent() {
            const dayIndex = parseInt(document.getElementById('edit-day').value);
             const newEvent = {
                id: Date.now(),
                time: document.getElementById('edit-time').value,
                title: document.getElementById('edit-title').value,
                desc: document.getElementById('edit-desc').value,
                type: document.getElementById('edit-type').value,
                bookingStatus: document.querySelector('input[name="bookingStatus"]:checked').value,
                important: document.getElementById('edit-important').checked,
                showMap: document.getElementById('edit-showMap').checked,
                openingHours: document.getElementById('edit-hours').value,
                transportType: document.getElementById('edit-type').value === 'transport' ? document.getElementById('edit-transport-type').value : null,
                transportRoute: document.getElementById('edit-type').value === 'transport' ? document.getElementById('edit-transport-route').value : null
            };
            itinerary[dayIndex].events.push(newEvent);
            itinerary[dayIndex].events.sort((a, b) => a.time.localeCompare(b.time));
            saveAll();
            closeModal();
            switchDay(dayIndex);
        }

        function deleteEvent(dayIndex, eventIndex) {
            itinerary[dayIndex].events.splice(eventIndex, 1);
            saveAll();
            closeModal();
            renderPlan();
        }
        
        function editDayTitle(dayIndex) {
            const day = itinerary[dayIndex];
            const newTitle = prompt("Enter new title for this day:", day.title);
            if(newTitle) {
                day.title = newTitle;
                const newSub = prompt("Enter subtitle:", day.subtitle);
                if(newSub) day.subtitle = newSub;
                saveAll();
                renderPlan();
            }
        }

        function saveBudget() {
            const val = document.getElementById('budget-input').value;
            if(val) { initialBudget = parseFloat(val); saveAll(); renderWallet(); closeModal(); }
        }

        function calculateConverter() {
            const input = document.getElementById('converter-input').value;
            const output = document.getElementById('converter-output');
            try {
                if (!input) { output.innerText = "NT$ 0"; return; }
                if (/[^0-9+\-*/.()\s]/.test(input)) { output.innerText = "Error"; return; }
                const jpy = eval(input);
                const twd = Math.round(jpy * exchangeRate);
                output.innerText = `NT$ ${twd.toLocaleString()}`;
            } catch (e) { }
        }

        function setPaymentMethod(method) {
            currentPaymentMethod = method;
            // Direct DOM update to prevent input clearing
            const activeClass = "flex-1 py-2.5 rounded border transition-all flex items-center justify-center gap-2 text-sm bg-ink text-paper border-ink";
            const inactiveClass = "flex-1 py-2.5 rounded border transition-all flex items-center justify-center gap-2 text-sm bg-white text-stone-400 border-stone-200 hover:border-stone-400";
            
            document.getElementById('btn-pay-cash').className = method === 'cash' ? activeClass : inactiveClass;
            document.getElementById('btn-pay-card').className = method === 'card' ? activeClass : inactiveClass;
            document.getElementById('btn-pay-suica').className = method === 'suica' ? activeClass : inactiveClass;
        }

        function setFilter(filter) { currentWalletFilter = filter; renderWallet(); }
        
        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amountStr = document.getElementById('expense-amount').value;
            if (!name || !amountStr) { alert("Please fill in both name and amount"); return; }
            expenses.push({ 
                id: Date.now(),
                desc: name, 
                amount: parseFloat(amountStr), 
                method: currentPaymentMethod, 
                date: new Date().toISOString() 
            });
            saveAll();
            renderWallet();
        }

        function switchDay(index) { if (index >= 0 && index < itinerary.length) { currentDayIndex = index; renderPlan(); } }
        
        function getTransportIcon(event) {
            if (event.type !== 'transport') return '';
            let icon = 'bus';
            if (event.transportType === 'flight') icon = 'plane-up';
            if (event.transportType === 'train') icon = 'train-subway';
            if (event.transportType === 'walk') icon = 'person-walking';
            if (event.transportType === 'charter') icon = 'van-shuttle';
            return `<i class="fa-solid fa-${icon} text-stone-300 text-sm ml-1"></i>`;
        }

        function getDocIcon(type) {
            switch(type) {
                case 'flight': return 'fa-plane'; case 'hotel': return 'fa-hotel'; case 'food': return 'fa-utensils'; case 'skiing': return 'fa-person-skiing'; case 'file': return 'fa-file-lines'; default: return 'fa-folder';
            }
        }

        // --- LISTS TAB SWITCHING ---
        function switchListTab(tab) {
            activeListTab = tab;
            renderLists();
        }

        function toggleCheck(index) { checklist[index].done = !checklist[index].done; saveAll(); renderLists(); }

        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const text = input.value.trim();
            if(text) {
                checklist.push({ text: text, done: false });
                saveAll();
                renderLists();
            }
        }

        function confirmDeleteChecklistItem(index) {
            openConfirmModal('Delete this item?', function() { deleteChecklistItem(index); });
        }

        function deleteChecklistItem(index) {
            checklist.splice(index, 1);
            saveAll();
            renderLists();
        }

        function addShoppingItem() {
            const input = document.getElementById('new-shop-item');
            const priceInput = document.getElementById('new-shop-price');
            const text = input.value.trim();
            const price = parseFloat(priceInput.value) || 0;
            if(text) {
                shoppingList.push({ text: text, price: price, done: false });
                saveAll();
                renderLists();
            }
        }

        function toggleShopCheck(index) {
            shoppingList[index].done = !shoppingList[index].done;
            saveAll();
            renderLists();
        }

        function confirmDeleteShoppingItem(index) {
            openConfirmModal('Delete shopping item?', function() { deleteShoppingItem(index); });
        }

        function deleteShoppingItem(index) {
            shoppingList.splice(index, 1);
            saveAll();
            renderLists();
        }

        function saveMemos(value) {
            memos = value;
            saveAll();
        }

        window.onload = function() {
            if (expenses.length > 0 && !expenses[0].method) { expenses.forEach(e => e.method = 'cash'); saveAll(); }
            renderPlan();
        }
    </script>
</body>
</html>
